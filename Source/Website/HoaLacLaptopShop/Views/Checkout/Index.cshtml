@model HoaLacLaptopShop.Models.Order

<link href="~/css/StyleSheet.css" rel="stylesheet">
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<div class="row">
    <div class="col-lg-8">
        <form asp-action="ConfirmOrder" method="post" asp-controller="Checkout">
            <!-- Billing Info -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Billing Info</h5>
                    <div class="form-row">
                        <div class="form-group col-lg-6">
                            <label for="name">Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="@Model.Buyer.Name" placeholder="Enter name" required>
                        </div>
                        <div class="form-group col-lg-6">
                            <label for="email">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email" value="@Model.Buyer.Email" placeholder="Enter email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-lg-6">
                            <label for="phone">Phone</label>
                            <input type="tel" class="form-control" id="phone" name="phone" value="@Model.Buyer.PhoneNumber" placeholder="Enter Phone no." required>
                        </div>
                        <div class="form-group col-lg-6">
                            <label for="country">Country</label>
                            <input type="text" class="form-control" id="country" name="country" value="Viet Nam" disabled>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-lg-6">
                            <label for="city">City</label>
                            <select class="form-control" id="city" name="city" placeholder="Choose city" required>
                                <option value="0">Select City</option>
                                // Options rendered here
                            </select>
                        </div>
                        <div class="form-group col-lg-6">
                            <label for="district">District</label>
                            <select class="form-control" id="district" name="district" required>
                                <option value="0">Select District</option>
                                // Options rendered here
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-lg-6">
                            <label for="ward">Ward</label>
                            <select class="form-control" id="ward" name="ward" placeholder="Choose Ward" required>
                                <option value="0">Select Ward</option>
                                // Options rendered here
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" class="form-control" id="address" name="address" placeholder="Enter address" required>
                    </div>
                    
                </div>
            </div>
           
            <!-- Payment Info -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Payment Info</h5>
                    <div class="row">
                        <div class="col-lg-3 selection-card active text-center" onclick="selectCard(this)">
                            <div class="custom-control custom-radio">
                                <input type="radio" id="creditCard" name="paymentMethod" class="custom-control-input" value="CreditCard"/>
                                <label class="custom-control-label">
                                    <i class="bx bx-credit-card d-block h2 mb-3"></i>
                                    <span class="mb-3 d-block">Credit / Debit Card</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-lg-3 selection-card text-center" onclick="selectCard(this)">
                            <div class="custom-control custom-radio">
                                <input type="radio" id="cashOnDelivery" name="paymentMethod" class="custom-control-input" value="CashOnDelivery"/>
                                <label class="custom-control-label">
                                    <i class="bx bx-money d-block h2 mb-3"></i>
                                    <span class="mb-3 d-block">Cash on Delivery</span>
                                </label>
                            </div>
                        </div>
                        <input type="hidden" id="voucherCode" name="voucherCode" value=""/>
                        <input type="hidden" id="discountValue" name="discountValue" value="" />
                    </div>
                </div>
            </div>
            <button class="btn btn-primary btn-lg" type="submit">Confirm Order</button>
        </form>
    </div>

    <div class="col-lg-4">
     <!-- Voucher Form (Separate) -->
        <form id="voucherForm" class="form-inline">
            <div class="form-group">
                <input type="text" class="form-control mr-2" id="voucher-code" placeholder="Enter voucher code">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
        <div class="order-summary">
            <h5>Order Summary</h5>
            <ul class="list-group mb-3">
                @foreach (var item in Model.OrderDetails)
                {
                    <li class="list-group-item d-flex justify-content-between" style="align-items: center">
                        <div>
                            <h6 class="my-0">@item.Product.Name</h6>
                            <small class="text-muted">@item.Product.Price * @item.Quantity</small>
                        </div>
                        <span class="text-muted">@string.Format("{0:N0}", item.Product.Price * item.Quantity)</span>
                    </li>
                }
                <li class="list-group-item d-flex justify-content-between">
                    <span>Sub Total</span>
                    <strong id="subtotal">@string.Format("{0:N0}", Model.OrderDetails.Sum(i => i.Product.Price * i.Quantity))</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Discount</span>
                    <strong id="discount-value">-0</strong> <!-- Adjust as necessary -->
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <strong>Total</strong>
                    <strong id="total-amount">@string.Format("{0:N0}", Model.OrderDetails.Sum(i => i.Product.Price * i.Quantity))</strong>
                </li>
            </ul>
        </div>
    </div>

</div>
<!-- Order Summary -->
<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
@*     <script src="https://cdn.jsdelivr.net/npm/popperjs/core@2.5.4/dist/umd/popper.min.js"></script> *@
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    // Get the select tags by id
    const provinceSelect = document.getElementById("city");
    const districtSelect = document.getElementById("district");
    const wardSelect = document.getElementById("ward");

    document.addEventListener('DOMContentLoaded', () => {

        function getProvinces() {
            fetch('https://esgoo.net/api-tinhthanh/1/0.htm')
                .then(function (response) {
                    return response.json();
                })
                .then(function (data_tinh) {
                    if (data_tinh.error === 0) {

                        data_tinh.data.forEach(function (val_tinh) {
                            var option = document.createElement('option');
                            option.value = val_tinh.full_name;
                            option.innerHTML = val_tinh.full_name;
                            option.setAttribute('data-province-id', val_tinh.id); // Set tinh.id as a data attribute
                            provinceSelect.appendChild(option);
                        });
                    }
                });
        }

        // Function to get districts
        function getDistricts(provinceId) {
            fetch('https://esgoo.net/api-tinhthanh/2/' + provinceId + '.htm')
                .then(function (response) {
                    return response.json();
                })
                .then(function (data_quan) {
                    if (data_quan.error === 0) {
                        districtSelect.innerHTML = ''; // Clear previous options

                        data_quan.data.forEach(function (val_quan) {
                            var option = document.createElement('option');
                            option.value = val_quan.full_name;
                            option.innerHTML = val_quan.full_name;
                            option.setAttribute('data-district-id', val_quan.id); // Set tinh.id as a data attribute
                            districtSelect.appendChild(option);
                        });
                    }
                });
        }

        function getWards(districtId) {
            fetch('https://esgoo.net/api-tinhthanh/3/' + districtId + '.htm')
                .then(function (response) {
                    return response.json();
                })
                .then(function (data_quan) {
                    if (data_quan.error === 0) {
                        wardSelect.innerHTML = ''; // Clear previous options

                        data_quan.data.forEach(function (val_phuong) {
                            var option = document.createElement('option');
                            option.value = val_phuong.full_name;
                            option.innerHTML = val_phuong.full_name;
                            wardSelect.appendChild(option);
                        });
                    }
                });
        }

        getProvinces();
        provinceSelect.addEventListener('change', function (e) {
            var selectedOption = e.target.options[e.target.selectedIndex];
            var provinceId = selectedOption.getAttribute('data-province-id'); // Get provinceId from data attribute
            getDistricts(provinceId);
        });

        districtSelect.addEventListener('change', (e) => {
            var selectedOption = e.target.options[e.target.selectedIndex];
            var districtId = selectedOption.getAttribute('data-district-id'); // Get districtId from data attribute;

            getWards(districtId)
        })
    })

    function selectCard(element) {
        // Remove 'active' class from all siblings
        const siblings = element.parentNode.children;
        for (let i = 0; i < siblings.length; i++) {
            siblings[i].classList.remove('active');
        }
        // Add 'active' class to the clicked element
        element.classList.add('active');
    }
</script>
<script>
    function formatCurrency(value) {
        return new Intl.NumberFormat('vi-VN', { style: 'decimal' }).format(value);
    };

     function parseCurrency(value) {
        return parseFloat(value.toString().replace(/./g, '').replace(/,/g, '.'));
    }

    const totalAmountElement = document.getElementById('total-amount');
    const discountElement = document.getElementById('discount-value');

    document.getElementById('voucherForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const voucherCode = document.getElementById('voucher-code').value;
        const subtotalElement = document.getElementById('subtotal');
        const subtotal = parseCurrency(subtotalElement.textContent);
        document.getElementById('voucherCode').value = voucherCode; // Update hidden field in the main form

        fetch('/Checkout/CheckVoucher', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '@Html.AntiForgeryToken()' // Ensure you generate this token correctly
            },
            body: JSON.stringify({ VoucherCode: voucherCode, Subtotal: subtotal })
        })
            .then(response => response.json())
            .then(data => {
                console.log(data)

                // document.getElementById('voucherCode').value = voucherCode;

                if (data.valid === true) {
                    discountElement.textContent = `-${formatCurrency(data.discount)}`;
                    totalAmountElement.textContent = `${formatCurrency(subtotal - data.discount)}`;
                } else {
                    discountElement.textContent = '-0';
                    totalAmountElement.textContent = formatCurrency(subtotal);
                }
            })
            .catch(error => console.error('Error:', error));
    });
    document.getElementById('discountValue').value = parseCurrency(discountElement);
</script>